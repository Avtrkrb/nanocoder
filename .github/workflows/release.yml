name: Release to NPM and GitHub

on:
  push:
    branches: [main]
  workflow_dispatch:
    inputs:
      version:
        description: 'Release version (e.g., 1.20.0)'
        required: true
        type: string
      pre_release:
        description: 'Is this a pre-release?'
        required: false
        type: boolean
        default: false

permissions:
  contents: write
  packages: write
  releases: write
  id-token: write

jobs:
  # Authorization check for manual releases
  authorize:
    if: github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest
    environment: release
    outputs:
      authorized: ${{ steps.check.outputs.authorized }}
    steps:
      - name: Check user permissions
        id: check
        uses: actions/github-script@v0
        with:
          script: |
            const maintainers = [
              'Avtrkrb',
              // Add other maintainers here
            ];
            const isMaintainer = maintainers.includes(context.actor);
            const isAdmin = context.payload.sender.type === 'Admin';

            if (!isMaintainer && !isAdmin) {
              core.setFailed(`User ${context.actor} is not authorized to create releases`);
              console.log('This action can only be triggered by project maintainers');
            }

            core.setOutput('authorized', isMaintainer || isAdmin);

  check-version:
    runs-on: ubuntu-latest
    outputs:
      should-publish: ${{ steps.version-check.outputs.should-publish }}
      package-version: ${{ steps.version-check.outputs.package-version }}
      npm-version: ${{ steps.version-check.outputs.npm-version }}
      is-manual: ${{ steps.version-check.outputs.is-manual }}
      manual-version: ${{ steps.version-check.outputs.manual-version }}
      is-pre-release: ${{ steps.version-check.outputs.is-pre-release }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Check version difference
        id: version-check
        run: |
          # Check if this is a manual trigger
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            echo "is-manual=true" >> $GITHUB_OUTPUT
            MANUAL_VERSION="${{ github.event.inputs.version }}"
            IS_PRE_RELEASE="${{ github.event.inputs.pre_release }}"
            echo "manual-version=${MANUAL_VERSION}" >> $GITHUB_OUTPUT
            echo "is-pre-release=${IS_PRE_RELEASE}" >> $GITHUB_OUTPUT
            echo "üîß Manual release triggered for version: ${MANUAL_VERSION}"

            # Validate version format
            if [[ ! "${MANUAL_VERSION}" =~ ^[0-9]+\.[0-9]+\.[0-9]+(-[a-zA-Z0-9]+)?$ ]]; then
              echo "‚ùå Invalid version format: ${MANUAL_VERSION}"
              echo "Expected format: X.Y.Z or X.Y.Z-tag"
              exit 1
            fi

            # Update package.json with manual version
            npm version ${MANUAL_VERSION} --no-git-tag-version
            echo "‚úÖ Updated package.json to version ${MANUAL_VERSION}"

            # Always publish for manual releases
            echo "should-publish=true" >> $GITHUB_OUTPUT
          else
            echo "is-manual=false" >> $GITHUB_OUTPUT
            echo "is-pre-release=false" >> $GITHUB_OUTPUT

            # Get current package.json version
            PACKAGE_VERSION=$(node -p "require('./package.json').version")
            echo "package-version=${PACKAGE_VERSION}" >> $GITHUB_OUTPUT
            echo "manual-version=${PACKAGE_VERSION}" >> $GITHUB_OUTPUT

            # Get latest NPM version (handle case where package doesn't exist yet)
            NPM_VERSION=$(npm view @nanocollective/nanocoder version 2>/dev/null || echo "0.0.0")
            echo "npm-version=${NPM_VERSION}" >> $GITHUB_OUTPUT

            # Compare versions
            if [ "$PACKAGE_VERSION" != "$NPM_VERSION" ]; then
              echo "‚úÖ New version detected: $PACKAGE_VERSION (current NPM: $NPM_VERSION)"
              echo "should-publish=true" >> $GITHUB_OUTPUT
            else
              echo "‚ÑπÔ∏è No version change detected: $PACKAGE_VERSION"
              echo "should-publish=false" >> $GITHUB_OUTPUT
            fi
          fi

  # Pre-release validation with matrix testing
  validate:
    if: needs.check-version.outputs.should-publish == 'true'
    needs: [check-version, authorize]
    environment: release
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
        node-version: [18, 20, 22]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Run full test suite
        run: pnpm test:all

      - name: Build project
        run: pnpm run build

      - name: Verify package integrity
        run: npm pack --dry-run

  publish:
    needs: [check-version, authorize, validate]
    if: |
      needs.check-version.outputs.should-publish == 'true' &&
      (github.event_name != 'workflow_dispatch' || needs.authorize.outputs.authorized == 'true')
    environment: release
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          registry-url: 'https://registry.npmjs.org'

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: latest

      - name: Install dependencies (including VS Code extension)
        run: pnpm install --frozen-lockfile

      - name: Build project
        run: pnpm run build

      - name: Build VS Code extension
        run: pnpm run build:vscode

      - name: Run tests
        run: pnpm test:all

      - name: Verify build output
        run: |
          if [ ! -f "dist/cli.js" ]; then
            echo "‚ùå Build failed: dist/cli.js not found"
            exit 1
          fi
          echo "‚úÖ Build successful: dist/cli.js exists"
          if [ ! -f "assets/nanocoder-vscode.vsix" ]; then
            echo "‚ùå Build failed: VS Code extension not found"
            exit 1
          fi
          echo "‚úÖ VS Code extension built: assets/nanocoder-vscode.vsix exists"

      - name: Extract Changelog
        id: changelog
        run: |
          # Extract changelog for current version
          CHANGELOG=$(node scripts/extract-changelog.js 2>&1)
          if [ $? -eq 0 ]; then
            echo "‚úÖ Changelog extracted successfully"
            # Use EOF to handle multi-line output
            echo "CHANGELOG<<EOF" >> $GITHUB_OUTPUT
            echo "$CHANGELOG" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
          else
            echo "‚ö†Ô∏è No changelog entry found, using default message"
            echo "CHANGELOG=No changelog available for this version." >> $GITHUB_OUTPUT
          fi

      - name: Publish to NPM
        run: npm publish --access public
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

      - name: Create GitHub Release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: v${{ needs.check-version.outputs.manual-version }}
          release_name: nanocoder v${{ needs.check-version.outputs.manual-version }}
          body: |
            ## What's Changed

            ${{ steps.changelog.outputs.CHANGELOG }}

            ### Installation
            ```bash
            npm install -g @nanocollective/nanocoder
            ```

            ### Usage
            ```bash
            nanocoder
            ```

            **Full Changelog**: https://github.com/Nano-Collective/nanocoder/compare/v${{ needs.check-version.outputs.npm-version }}...v${{ needs.check-version.outputs.manual-version }}
          draft: false
          prerelease: ${{ needs.check-version.outputs.is-pre-release }}

      - name: Send Discord Notification
        if: success()
        run: |
          curl -H "Content-Type: application/json" \
            -d '{
              "embeds": [{
                "title": "üéâ New Release: Nanocoder v${{ needs.check-version.outputs.manual-version }}",
                "description": "A new version of Nanocoder has been released!\n\n[View the full changelog on GitHub](https://github.com/${{ github.repository }}/releases/tag/v${{ needs.check-version.outputs.manual-version }})",
                "color": 5763719,
                "fields": [
                  {
                    "name": "Version",
                    "value": "v${{ needs.check-version.outputs.manual-version }}",
                    "inline": true
                  },
                  {
                    "name": "Installation",
                    "value": "`npm install -g @nanocollective/nanocoder`",
                    "inline": false
                  }
                ],
                "footer": {
                  "text": "GitHub Actions"
                },
                "timestamp": "'$(date -u +%Y-%m-%dT%H:%M:%S.000Z)'",
                "url": "https://github.com/${{ github.repository }}/releases/tag/v${{ needs.check-version.outputs.manual-version }}"
              }]
            }' \
            ${{ secrets.DISCORD_WEBHOOK_URL }}

  update-nix:
    needs: [check-version, publish]
    if: needs.check-version.outputs.should-publish == 'true'
    uses: ./.github/workflows/update-nix.yml
    with:
      version: ${{ needs.check-version.outputs.manual-version }}
    secrets:
      PAT_TOKEN: ${{ secrets.PAT_TOKEN }}

  update-homebrew:
    needs: [check-version, publish, update-nix]
    if: needs.check-version.outputs.should-publish == 'true'
    uses: ./.github/workflows/update-homebrew.yml
    with:
      version: ${{ needs.check-version.outputs.manual-version }}
    secrets:
      PAT_TOKEN: ${{ secrets.PAT_TOKEN }}

  notify:
    needs: [check-version, publish, update-nix, update-homebrew]
    if: always()
    runs-on: ubuntu-latest
    steps:
      - name: Update badges after release
        if: needs.check-version.outputs.should-publish == 'true' && needs.publish.result == 'success'
        run: |
          # Trigger badge update workflow
          curl -X POST \
            -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            -H "Accept: application/vnd.github.v3+json" \
            https://api.github.com/repos/${{ github.repository }}/actions/workflows/update-badges.yml/dispatches \
            -d '{
              "ref": "main"
            }' || echo "Failed to trigger badge update"

      - name: Notify result
        run: |
          if [ "${{ needs.check-version.outputs.should-publish }}" == "true" ]; then
            if [ "${{ needs.publish.result }}" == "success" ]; then
              echo "üéâ Successfully published @nanocollective/nanocoder v${{ needs.check-version.outputs.manual-version }} to NPM and created GitHub release!"
              if [ "${{ needs.update-nix.result }}" == "success" ]; then
                echo "‚úÖ Nix package updated successfully!"
              else
                echo "‚ö†Ô∏è Warning: Nix package update failed"
              fi
              if [ "${{ needs.update-homebrew.result }}" == "success" ]; then
                echo "‚úÖ Homebrew formula updated successfully!"
              else
                echo "‚ö†Ô∏è Warning: Homebrew formula update failed"
              fi
            else
              echo "‚ùå Failed to publish @nanocollective/nanocoder v${{ needs.check-version.outputs.manual-version }}"
              exit 1
            fi
          else
            echo "‚ÑπÔ∏è No new version to publish (current: ${{ needs.check-version.outputs.manual-version }})"
          fi
