name: Update Status Badges

on:
  push:
    branches: [main]
  workflow_dispatch:
  schedule:
    - cron: '0 */6 * * *'  # Every 6 hours

permissions:
  contents: write

jobs:
  generate-badges:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Run tests for latest coverage
        run: pnpm run test:ava:coverage

      - name: Extract coverage percentage
        id: coverage
        run: |
          if [ -f coverage/coverage-summary.json ]; then
            COVERAGE=$(cat coverage/coverage-summary.json | jq -r '.total.lines.pct')
            echo "percentage=${COVERAGE}" >> $GITHUB_OUTPUT
            echo "Current coverage: ${COVERAGE}%"

            # Determine color based on coverage
            if (( $(echo "${COVERAGE} >= 80" | bc -l) )); then
              COLOR="brightgreen"
            elif (( $(echo "${COVERAGE} >= 60" | bc -l) )); then
              COLOR="orange"
            else
              COLOR="red"
            fi
            echo "color=${COLOR}" >> $GITHUB_OUTPUT
          else
            echo "percentage=0" >> $GITHUB_OUTPUT
            echo "color=red" >> $GITHUB_OUTPUT
          fi

      - name: Get current version
        id: version
        run: |
          VERSION=$(npm pkg get version | tr -d '"')
          echo "version=${VERSION}" >> $GITHUB_OUTPUT

      - name: Create badges directory
        run: mkdir -p badges

      - name: Generate coverage badge
        uses: schneegans/dynamic-badges-action@v1.7.0
        with:
          auth: ${{ secrets.GITHUB_TOKEN }}
          gistID: ${{ secrets.BADGE_GIST_ID }}
          label: coverage
          message: ${{ steps.coverage.outputs.percentage }}%
          color: ${{ steps.coverage.outputs.color }}
          filename: coverage.svg
          path: badges/

      - name: Generate version badge
        uses: schneegans/dynamic-badges-action@v1.7.0
        with:
          auth: ${{ secrets.GITHUB_TOKEN }}
          gistID: ${{ secrets.BADGE_GIST_ID }}
          label: version
          message: ${{ steps.version.outputs.version }}
          color: blue
          filename: version.svg
          path: badges/

      - name: Generate build badge
        uses: schneegans/dynamic-badges-action@v1.7.0
        with:
          auth: ${{ secrets.GITHUB_TOKEN }}
          gistID: ${{ secrets.BADGE_GIST_ID }}
          label: build
          message: passing
          color: brightgreen
          filename: build.svg
          path: badges/

      - name: Create simple SVG badges (fallback)
        run: |
          # Coverage badge
          COVERAGE=${{ steps.coverage.outputs.percentage }}
          COLOR=${{ steps.coverage.outputs.color }}
          cat > badges/coverage.svg << EOF
          <svg xmlns="http://www.w3.org/2000/svg" width="100" height="20">
            <linearGradient id="b" x2="0" y2="100%">
              <stop offset="0" stop-color="#bbb" stop-opacity=".1"/>
              <stop offset="1" stop-opacity=".1"/>
            </linearGradient>
            <rect rx="3" width="100" height="20" fill="#555"/>
            <rect rx="3" x="50" width="50" height="20" fill="#${COLOR}"/>
            <path fill="#${COLOR}" d="M50 0h4v20h-4z"/>
            <g fill="#fff" text-anchor="middle" font-family="DejaVu Sans,Verdana,Geneva,sans-serif" font-size="11">
              <text x="25" y="14">coverage</text>
              <text x="75" y="14">${COVERAGE}%</text>
            </g>
          </svg>
          EOF

          # Version badge
          VERSION=${{ steps.version.outputs.version }}
          cat > badges/version.svg << EOF
          <svg xmlns="http://www.w3.org/2000/svg" width="90" height="20">
            <linearGradient id="b" x2="0" y2="100%">
              <stop offset="0" stop-color="#bbb" stop-opacity=".1"/>
              <stop offset="1" stop-opacity=".1"/>
            </linearGradient>
            <rect rx="3" width="90" height="20" fill="#555"/>
            <rect rx="3" x="40" width="50" height="20" fill="#0366d6"/>
            <path fill="#0366d6" d="M40 0h4v20h-4z"/>
            <g fill="#fff" text-anchor="middle" font-family="DejaVu Sans,Verdana,Geneva,sans-serif" font-size="11">
              <text x="20" y="14">version</text>
              <text x="65" y="14">${VERSION}</text>
            </g>
          </svg>
          EOF

          # Build status badge
          cat > badges/build.svg << EOF
          <svg xmlns="http://www.w3.org/2000/svg" width="80" height="20">
            <linearGradient id="b" x2="0" y2="100%">
              <stop offset="0" stop-color="#bbb" stop-opacity=".1"/>
              <stop offset="1" stop-opacity=".1"/>
            </linearGradient>
            <rect rx="3" width="80" height="20" fill="#555"/>
            <rect rx="3" x="35" width="45" height="20" fill="#28a745"/>
            <path fill="#28a745" d="M35 0h4v20h-4z"/>
            <g fill="#fff" text-anchor="middle" font-family="DejaVu Sans,Verdana,Geneva,sans-serif" font-size="11">
              <text x="18" y="14">build</text>
              <text x="58" y="14">passing</text>
            </g>
          </svg>
          EOF

      - name: Update README with badges
        run: |
          # Create badge URLs
          REPO="${{ github.repository }}"
          COVERAGE_BADGE="https://github.com/${REPO}/raw/main/badges/coverage.svg"
          VERSION_BADGE="https://github.com/${REPO}/raw/main/badges/version.svg"
          BUILD_BADGE="https://github.com/${REPO}/raw/main/badges/build.svg"

          # Check if README already has badges section
          if grep -q "## ðŸ“Š Status" README.md; then
            # Update existing badges
            sed -i "s|!\[coverage\].*|![coverage](${COVERAGE_BADGE})|g" README.md
            sed -i "s|!\[version\].*|![version](${VERSION_BADGE})|g" README.md
            sed -i "s|!\[build\].*|![build](${BUILD_BADGE})|g" README.md
          else
            # Add badges section at the top
            sed -i "1i\\## ðŸ“Š Status\n\n![coverage](${COVERAGE_BADGE}) ![version](${VERSION_BADGE}) ![build](${BUILD_BADGE})\n" README.md
          fi

      - name: Commit and push badges
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add badges/ README.md
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "Update status badges [skip ci]"
            git push
          fi

      - name: Verify badge generation
        run: |
          echo "Generated badges:"
          ls -la badges/
          echo ""
          echo "Badge sizes:"
          wc -c badges/*